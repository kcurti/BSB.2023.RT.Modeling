---
title: Application of the Woods Hole Assessment Model to Black Sea Bass
author: 
  - Timothy J. Miller$^{1,*}$
  - Kiersten Curti$^1$
  - Alex Hansell$^1$
institute:
  - $^1$Northeast Fisheries Science Center, National Marine Fisheries Service, 166 Water Street, Woods Hole, MA 02543, USA
date: ""
output:
  bookdown::pdf_document2:
    toc: no
    lot: yes
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
    includes:
      in_header: options.sty
  html_document:
    df_print: paged
csl: fisheries-research.csl
bibliography: bsb-wham.bib
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE, fig.align = "center")
#knitr::opts_knit$set(root.dir = '../')
library(knitr)
library(tidyverse)
library(pander)
library(kableExtra)
library(TMB)
#library(ggplotFL)
library(viridis)
library(wham, lib.loc = "c:/work/wham/old_packages/multi_wham")
type <- "latex"
if(knitr::is_latex_output()) type <- "latex"
if(knitr::is_html_output()) type <- "html"
options(knitr.kable.NA = '')

```

$^1$Northeast Fisheries Science Center, National Marine Fisheries Service, 166 Water Street, Woods Hole, MA 02543, USA\
$^*$Contact info: timothy.j.miller@noaa.gov

\pagebreak

# Summary {-}

The Woods Hole Assessment Model (WHAM) software package is maintained and developed at the Northeast Fisheries Science Center to enable state-space stock assessments, i.e. where processes such as recruitment, the annual transitions in numbers-at-age (survival), natural mortality, selectivity, and catchability are treated as time- and, in some cases, age-varying random effects.

The current proposed model for management uses a multi-stock, multi-region extension of WHAM to model the northern and southern components of the stock and movement of the northern component simultaneously. The WHAM extension does not yet have the ability to use tagging data to inform the model, so it uses estimates of movement parameters from a Stock Synthesis application to define prior distributions for movement rates which are treated as random effects. VAST and Recreational catch per angler indices for the northern and southern regions along with corresponding age composition data are used to inform the model. Catch and associated age composition data for regional recreational and commercial fleets are also used. The model also includes effects of a winter bottom temperature covariate in the northern region on recruitment of the stock component in that region. Process errors in the latent bottom temperature covariate, recruitment, survival, and selectivity of some fleets and indices are estimated as random effects.

We arrived at the proposed base model from analyzing more than 30 different fits the multi-stock version of WHAM to different sets of observations. The proposed base model exhibits no retrospective patterns in fishing mortality or SSB for either region and OSA residuals appear adequate for most of the data components. Reference point estimates suggest the slight overfishing of the entire stock, but that the stock is far from overfished. Example 3 year projections are also provided.

\pagebreak

# Introduction

Black sea bass is currently assessed using ASAP, the Age-Structured Assessment Program [@legaultrestreppo98; @millerlegault15]. ASAP is a statistical catch-at-age (SCAA) model which estimates all model parameters as fixed effects. The standard version of the Woods Hole Assessment Model can only be applied to a single stock and area [@stockmiller21,@millerstock20]. Here we use a multi-stock, multi-region extension of WHAM [https://github.com/timjmiller/wham/tree/lab, @miller_bsb_wham_wp] for black sea bass originating and spawning in northern and southern regions of the US NE Shelf divided by the Hudson Canyon.

# Methods

All code used for model fits along with results summaries can be found at https://github.com/kcurti/BSB.2023.RT.Modeling.

## Early runs

The development of the multi-stock, multi-area version of WHAM was driven primarily by the needs of black sea bass and NEUS stocks of Atlantic cod. Because this extension to WHAM represents a major change to the code used to configure and estimate models, we compared results from fits of separate ASAP models and separate fits using the standard WHAM model for each region, and simultaneous fits of the regional components in the new extension of WHAM without any movement (Figure \ref{fig:compare-asap-wham}). All WHAM fits assume no random effects and estimate annual recruitment parameters as fixed effects. Estimates fro the latter fit and those from fits using the standard WHAM model provide identical results, but ASAP fits provide small differences in estimates for the northern component.

## Model configurations

The first 18 runs that used updated and new observations included either separate indices for all surveys or fall and spring VAST indices that combined all surveys other than the recreational CPA (Table \ref{tab:wham-runs}). Many of these runs explored alternative selectivity and age composition assumptions to reduce patterns observed in the OSA residuals for age composition observations. We then found that the age composition for fall FAST and NEAMAP indices were incorrectly calculated. Then from Run 19 onward we only used the spring VAST and Recreational CPA indices. 

From Run 19-27 we still had issues reducing patterns in OSA residuals and sometimes large patterns in retrospective patterns for the northern component. We then decided to iterate among alternative assumptions about selectivity and age composition models with the northern and southern components separately to resolve diagnostic problems more efficiently. These analyses resulted in different age composition model assumptions for different fleets and indices and the use of selectivity random effects for the northern fleets and indices (Table \ref{tab:age-comp-sel-table}). 

Runs 28-34 largely used these same assumptions. For these last runs with movement, more realistic assumptions about movement and more appropriate usage of the estimates from the stock synthesis runs [@fay_bsb_ss_wp]. Run 31 assumed temporal random effects on the movement rate from the north to the south and Run 32 assumed a Beverton-Holt stock recruit relationships for both the north and south components, but convergence was problematic for both of these models. Run 33 investigated bottom temperature effects on recruitment and we found evidence of an effect on northern recruitment.  Run 34 then relaxed an assumption common to many earlier runs about the estimated uncertainty in the Recreational CPA indices and allowed a scalar to be estimated in the model. Further details of model configuration of Runs 28-34 are described below.

## Seasonality and movement

The WHAM model assumes 11 intervals within each calendar year: 5 monthly time intervals from Jan 1 to May 31, a spawning season from June 1 to July 31, and 5 monthly intervals from August 1 to December 31. All southern fish are assumed to never move to the northern region. Northern fish are all in the northern region during the spawning period. A proportion $p_1$ of northern fish can move to the south each month during the last 5 months of the year, but no movement is allows from the south to the north during this period. For the first 4 months of the year a proportion $p_2$ of northern fish in the south can move back to the north, but no movement from the north to south is allowed during this period. In the fifth month any northern fish still in the south are assumed to move back to the north for the subsequent spawning period. We configured survival and movement to occur sequentially in each interval. Each of the two proportions are assumed constant across intervals, age, and year.

The monthly movement matrices are
\begin{equation*}
\mathbf{p}_{1} = 
  \begin{bmatrix}
     1-p_1 & p_1 \\
     0 & 1 \\
  \end{bmatrix}
\end{equation*}
for the portion of the year after spawning and
\begin{equation*}
\mathbf{p}_{2} = 
  \begin{bmatrix}
     1 &  0 \\
     p_2 & 1-p_2 \\
  \end{bmatrix}
\end{equation*}
for the portion of the year before spawning.

### Prior distribution for movement rates

The Stock Synthesis model has 2 seasons (6 months each) where a proportion $P_1$ of the northern component moves to the south in one season and some proportion  $P_2$ move back to the south in the second season [@fay_bsb_ss_wp]. The movement matrices for each season is
\begin{equation*}
\mathbf{P}_{1} = 
  \begin{bmatrix}
     1-P_1 & P_1 \\
     0 & 1 \\
  \end{bmatrix}
\end{equation*}
and
\begin{equation*}
\mathbf{P}_{2} = 
  \begin{bmatrix}
     1 &  0 \\
     P_2 & 1-P_2 \\
  \end{bmatrix}.
\end{equation*}

We approximate the monthly movement matrices as the roots $\mathbf{P}_1$ and $\mathbf{P}_2$ defined by the number of months of movement for each season (5 and 4, respectively): $\mathbf{p}_1 = \mathbf{P}_1^{\frac{1}{5}}$ and $\mathbf{p}_2 = \mathbf{P}_2^{\frac{1}{4}}$. Given the proportion parameter, the eigen decomposition of the matricies can be used to define the roots
$$  \mathbf{P}_1^{1/5} = \mathbf{V}_1 \mathbf{D}_1^{\frac{1}{5}} \mathbf{V}_1^{-1}$$
$$  \mathbf{P}_2^{1/4} = \mathbf{V}_2 \mathbf{D}_2^{\frac{1}{4}} \mathbf{V}_2^{-1}$$
where $\mathbf{V}_i$ and $\mathbf{D}_i$ are the matrix of eigenvectors (columnwise) and the diagonal matrix of corresponding eigenvalues of $\mathbf{P}_i$ for parameter $P_i$. Note, for diagonal matrices, $\mathbf{D}_i^k$ is equal to the diagonal matrix with the elements raised to the power $k$.

We used a parametric bootstrap approach to determine an appropriate standard deviation for the prior distribution for the movement parameters. 
The actual SS parameter estimates $x_1=-1.44$ and $x_2=1.94$ are transformations of $P_1=0.11$ and $P_2=0.78$ such that
$$
P_i = \frac{1}{1 + 2e^{-x_i}}
$$
In WHAM a logit transformation is used 
$$
p_i = \frac{1}{1+e^{-y_i}}.
$$
We simulated 1000 values from a normal distribution with mean and standard deviation defined by the SS parameter estimate and standard error $\tilde x_i \sim N(x_i, SE(x_i))$. For each simulated value we constructed $\mathbf{P}_i$, took the appropriate root and calculated inverse logit for $\tilde y_i$. We calculated the mean and standard deviation of the values $y_i$. The mean values did not differ meaningfully from the transformation of the original estimates ($y_1 = -3.79$ and $y_2 = -0.79$) and the standard deviation was approximately 0.2 for both parameters.

## Initial abundance at age

With the movement configuration, the northern origin fish (ages 2+) can occur in the southern region on January 1. Estimating initial numbers at age as separate parameters can be challenging even in single-stock models. To avoid challenges with estimating initial numbers at age in each region for the northern component in the two stock model, we used the equilibrium assumption described in @miller_bsb_wham_wp. Using this assumption two parameters are estimated for each regional component: an initial recruitment and an equilibrium full F across all fleets.

## Recruitment and Survival

For the northern population abundance at age 1 on January 1 (recruitment) is only allowed in the northern region, but given the monthly movement described above, older individuals that previously recruited in the northern region may occur in the southern region on January 1. Therefore, a model with survival random effects will model the transitions (survival/movement) of abundances at age of northern origin fish in each region. All of the initial runs assumed variance parameters for these random effects to be the same for northern origin fish occurring in both regions on January 1. The base model assumes very small variance for the transitions of northern fish in the southern region, which is essentially the same as the deterministic transition assumptions of a statistical catch at age model. We also allow 2DAR1 correlation for recruitment and survival for both the northern and southern components. Variance and correlation parameters for the recruitment and survival random effects are different for the northern and southern components.

## Uncertainty recreational CPA index observations

The CVs provided by the analyses for the recreational catch per angler (RecCPA) ranged between 0.02 and 0.06 which the working group felt did not capture the true uncertainty in the index with regard to its relationship to stock abundance. In many of the initial runs as well as the base model we allowed a scalar multiple of the standard deviation of the log aggregate index to be estimated for these indices in the northern and southern regions. Models that successfully estimated these scalars indicated standard deviations for these surveys to be  approximately 5 times the input value and this value was fixed in many preliminary runs to avoid dealing with convergence problems. However, the base model successfully estimated these scalars. The model estimates are negligibly affected by estimating these scalars, but we felt estimating these parameters allowed uncertainty in model output to be more properly conveyed.

## Bottom Temperature effects on recruitment

We have bottom temperature observations for the northern and southern regions from 1963 to 2021 and estimated standard errors of those observations. We assumed AR1 models for the latent bottom temperature covariates in each region which are relatively precise with standard errors ranging between 0.03 and 0.09 degrees Celsius. We fit models with the bottom temperature covariate observations in the model, but without effects on recruitment.  This is the null model which can be compared with models with effects on recruitment using AIC because the observations included in each model are the same. We fit models with effects of the regional bottom temperatures on both the respective stock components and just effect of the northern bottom temperature covariate on recruitment of the northern stock. These analyses derive from the hypothesis that bottom temperature affects overwinter survival of fish where the fish turn from age 0 to age 1 on January 1 [@milleretal16_yoy_survival]. 

We assume the covariate in year $y$ affects recruitment in the same years because the covariate observations are from months January to March. The fish are technically already 1 year old, but there are no observations of these individuals until later in the year except possibly in fishery catches which are accumulated over the whole year. Expected log-recruitment is a linear function of log-recruitment at the previous time step and bottom temperature

\begin{equation}\label{eq:expected-recruitment}
\log R_y = \mu_R + \beta x_y + \epsilon_y
\end{equation}


## Diagnostics

### Jitter analysis

For this analysis we simulated fixed effects parameter vectors from a normal distribution with mean equal to the optimized values and covariance equal to the hessian-based covariance matrix. From refitting the model starting at 16 different simulated parameter vectors, we found 3 cases with a lower (~2 units) marginal negative log likelihood (Figure \ref{fig:jitter-res-1}). The gradients at these optimized values were satisfactory and there was no difference in parameter value among the 3 lower optimizations. In 1 of the 16 iterations, the model did not optimized satisfactorily, and in the other 12 iterations, the optimized marginal negative log-likelihood and parameter estimates were identical to the original fit. The parameters with estimates that differed most between the 2 optimization results were those associated with age composition observation dispersion parameters.

Given the revised model fit with the lower marginal NLL, we used the same jittering method with 100 simulated parameter values as starting values (Figure \ref{fig:jitter-res-2}). Three of the fits failed to complete, but none of the iterations resulted in lower marginal negative log-likelihood than that from the revised model estimates. Three of the fits minimized to greater marginal NLLs, but the gradients indicate lack of convergence. \textbf{The revised model fit is the proposed base model.}

### Self tests

We performed a simulation self-test where new observations were simulated conditional on all random effects estimated in the proposed base model and the same model configuration was fit to each of the simulated data sets. For only 6 of the 100 simulated data sets, was the maximum absolute gradient for the fitted model was less than $1\times10^{-6}$. This appeared to be attributable to the estimation of the scalar for the standard errors of the log-transformed Northern Recreational CPA index for which estimates nearly always tended to 0 However, even across all fits including those with poor convergence, the SSB estimates appeared to be reliable (Figure \ref{fig:self-test-res-2}). For comparison we also fit a model that assumed the standard error scalars for both the northern and southern Recreational CPA log-indices were fixed at the true values (estimates from the original data). We observed much better convergence with 87 fits having maximum absolute gradient for the fitted model was less than $1\times10^{-6}$.  Interestingly, estimation from this model implied slightly greater biases in some annual SSB estimates (Figure \ref{fig:self-test-res-3}).

### MASE

We performed an analysis of the prediction skill of the proposed base model. We fit 7 configurations of the model where the last 1 to 7 years of aggregate index and age composition observations were removed sequentially (peels). We calculated the MASE statistics as described in @kelletal21. The mean absolute scaled error (MASE) of the predictions at 1 to 5 years beyond the final year of index observations (horizons). The mean absolute errors are scaled by the mean absolute errors of so-called naïve predictions using the aggregate index observation from the final year of each peel. A MASE < 1 results when the mean absolute error is greater using the model than the naïve forecast. For the proposed base model, predictions for 3 of the 4 surveys performed similarly to naïve predictions across all horizons, but MASE scores were particularly poor for the northern region recreational CPA index (Figure \ref{fig:mase-by-index}). This poor performance occurs because the index has no trend and low variability over the years used for the calculation whereas the model predictions vary much more (Figure \ref{fig:mase-obs-pred-by-index}).

### One-step-ahead residuals

We used one-step-ahead (OSA) residuals to evaluate mis-specification of the proposed base model. Pearson residuals do not have the appropriate properties (iid standard normal for a correctly specified model) for composition observations [@trijouletetal23] or for covariate and aggregate index and catch observations when temporal random effects are employed  because of the lack of independence of observations [@thygesenetal17].

There is no evidence of mis-specificaiton from the OSA residuals for aggregate catch of the northern commercial fleet (Figure \ref{fig:osa-North-comm-catch-summ}). There was some indication of trends in residuals  of some of the age composition observations early in the time series and for the the first age class (Figures \ref{fig:osa-North-comm-paa-summ} and \ref{fig:osa-North-comm-paa}). 

For the northern recreational fleet, the OSA residuals for the aggregate catch appeared satisfactory (Figure \ref{fig:osa-North-rec-catch-summ}). The OSA residuals for the age composition observations for the northern recreational fleet showed some tendency of underdispersion but were otherwise unnoteworthy (Figures \ref{fig:osa-North-rec-paa-summ} and \ref{fig:osa-North-rec-paa}). 

Neither the OSA residuals for the aggregate catch or the age composition of the Northern recreational CPA index exhibited signs of mis-specification (Figures \ref{fig:osa-North-reccpa-catch-summ} to \ref{fig:osa-North-reccpa-paa}).  

There was a little evidence of tendency toward negative OSA residuals for the Northern VAST index whereas there was some indication of positive residuals for the age composition observations, particularly at age 1 (Figures \ref{fig:osa-North-vast-catch-summ} to \ref{fig:osa-North-vast-paa})

THe OSA residuals for the aggregate catch of the southern recreational fleet tended to be negative, but the residuals for the age composition observations did not show any evidence of mis-specification (Figures \ref{fig:osa-South-comm-catch-summ} to \ref{fig:osa-South-comm-paa}).

The OSA residuals for the aggregate catch of the southern recreational fleet were under-dispersed and those for the age composition were somewhat underdispersed, but no trends in either types of observations were apparent (Figures \ref{fig:osa-South-rec-catch-summ} to \ref{fig:osa-South-rec-paa})

The OSA residuals for the aggregate catch of the southern recreational CPA index were also somewhat under-dispersed (Figures \ref{fig:osa-South-reccpa-catch-summ}). The residuals for the age composition observations exhibited a few large negative residuals at older ages, but otherwise exhibited no apparent trends (Figures \ref{fig:osa-South-reccpa-paa-summ} to \ref{fig:osa-South-reccpa-paa})

The OSA residuals for the aggregate southern VAST index were somewhat over-dispersed and the residuals for the age composition appeared to show some trend with observed proportion and age (Figures \ref{fig:osa-South-vast-catch-summ} to \ref{fig:osa-South-vast-paa}).

### Retrospective patterns

We also examined retrospective patterns by fitting models where the terminal year is reduced sequentially by one year (peel) for seven years. Therefore, there are 7 fits of the proposed base model with the time series reduced by one to seven years. WHAM performs these fits when specified and will calculate Mohn's $\rho$ for recruitment, SSB, and fully-selected $F$. Absolute values of Mohn's $\rho$ near 0 imply no pattern in estimation of these quantities as the time-series is sequentially extended. Although there was strong retrospective patterns in the most recent management track assessment for the northern component of the stock, there was no evidence of patterns for northern SSB (Mohn's $\rho$ = -0.054) and $F$ (Mohn's $\rho$ = 0.058) for the proposed base model (Figures \ref{fig:North-retro-ssb} and \ref{fig:North-retro-F}). Similarly, no patterns were exhibited for the southern component of SSB (Mohn's $\rho$ = -0.007) and regional $F$  (Mohn's $\rho$ = -0.045) (Figures \ref{fig:South-retro-ssb} and \ref{fig:South-retro-F}).


# Proposed base model results

For an exhaustive set of summary plots and tables for the proposed base model see wham_figures_tables.html in the repository: https://github.com/kcurti/BSB.2023.RT.Modeling/tree/main/2023.RT.Runs/Run34. 

## Bottom temperature effect on recruitment

We found the best model of bottom temperature covariate effects included the effect only on the recruitment of the northern stock, which is the configuration in the proposed base model (Table \ref{tab:compare-table}). The posterior estimate of the bottom temperature covariate match the observations well because of the high precision of the observations (Figure \ref{fig:bottom-temp}). The residual variation in the standard deviation of recruitment random effects is reduced because the expected recruitment (Eq. \ref{eq:expected-recruitment}) is a function of the covariate  (Figure \ref{fig:relative-recruitment-bt}). This effect is included in the proposed base model (Figure \ref{fig:rec-bottom-temp}). Because the covariate is technically for temperature after the beginning of the calendar year when the fish are considered age 1 in the model, a comparison of the proposed base model to one with the bottom temperature effect on natural mortality at age 1 instead might be of interest in the future. An investigation of higher order orthogonal polynomial effects might also be of interest particularly for the southern component which might be experiencing more frequently higher temperatures less favorable to overwinter survival.

## Comparison of Runs 30, 33 and 34

The estimates of SSB, fully-selected fishing mortality, and recruitment were very similar for Runs 30, 33, and the incorrectly and correctly optimized fits for Run34 (Figures \ref{fig:SSB-compare} to \ref{fig:R-compare}). 

Allowing the scalar for the standard error of the log-transformed Rec CPA indices to be estimated in the proposed base model results in a slight increase in uncertainty of spawning stock biomass estimates (Figure \ref{fig:relative-se-ssb-R}).

## Parameter estimates

The estimated fixed effects parameters other than those for annual fully-selected fishing mortality are provided in Table \ref{tab:par-table}. The parameters defining autocorrelation across years for the numbers at age deviations are positive for both regional stock components, but do not indicate particularly strong correlation which manifests in rapid return to 0 in projection years (Figure \ref{fig:NAA-devs}). The estimated correlation across age for both stock components suggest an independence assumption may be more parsimonious (confidence intervals include 0).

The posterior estimate of the movement rate from the north to the south for the northern component is much lower than the mean of the prior distribution estimated from the Stock Synthesis application (Figure \ref{fig:move-prior-posterior}).

The proposed base model estimates a temporal change in selectivity from several fully selected ages to primarily the oldest ages for the northern recreational fleet (Figure \ref{fig:selectivity}). This correspond well with the regulatory changes that repeatedly increased size limit over time [@rec_catch_wp, Figure 13].

## Spawning stock biomass, fishing mortality, and recruitment

The estimates of SSB for the northern component in recent years are the highest during the time series for either region (Figure \ref{fig:SSB-R-time} and \ref{fig:SSB-F}). Fully-selected fishing mortality rates have been similar for the two regions over the time series, but the rates for the recreational fleet in the northern region have gone from the lowest of the four fleets in the 1990s to the highest in the last decade (Figure \ref{fig:F-by-fleet}). 

# Reference points

WHAM has various options for calculating biological reference points. It will provide annual estimates of SPR-based reference points that use the annual inputs to the per-recruit calculations for F at a specified percentage of unfished spawning biomass per recruit. For black sea bass annual estimates of $F_{40}$ and SSB at $F_{40}$ are as well as the status of annual F and SSB estimates relative to these reference points (Figures \ref{fig:annual-BRPs} and \ref{fig:annual-status}). 

For management, the current assessment uses the average by age of the most recent 5 years for maturity, SSB weight, catch weight, fleet selectivity, and natural mortality to calculate $F_{40}$ and average of annual recruitment for years after 1999 for SSB at $F_{40}$. We use these same configurations for the proposed base model. Viewing the bivariate estimate of status as a posterior distribution, the current status 0.59 probability of overfishing but not being overfished and 0.41 probability of not overfishing and not being overfished (Figure \ref{fig:kobe-status}).

# Projections


The same options in the basic single stock WHAM model are available in the multi-stock extension. To demonstrate the the projection capability, we configured a three year projection with catch set to 10kmt in 2022 and fishing at $F_{40}$ in the subsequent two years (Figure \ref{fig:F-by-fleet-proj}). Models for random effects on the bottom temperature covariate, recruitment, survival are used to predict bottom temperature and abundance at age in the projection years (Figures \ref{fig:bottom-temp-proj} and \ref{fig:NAA-devs-proj}). 

When fishing at $F_{40}$ the northern component of the population is reduced dramatically. This occurs because of the remove of a large 2016 year class without any subsequent strong recruitments to replace those individuals (Figure \ref{fig:SSB-R-time-proj} and \ref{fig:SSB-F-proj}). However, note that the status of the stock is still far from being overfished (Figure \ref{fig:kobe-status-proj}).

A full set of plots for the projected model can be found in wham_figures_tables.html in the repository: https://github.com/kcurti/BSB.2023.RT.Modeling/tree/main/2023.RT.Runs/Run34/projections. 


# References {-}

<div id="refs"></div>

\pagebreak

```{r, echo = F, eval = T}
library(TMB)
null_mod <- readRDS(here::here("2023.RT.Runs","Run33","fit_no_effect.RDS"))
sat_mod <- readRDS(here::here("2023.RT.Runs","Run33","fit_both_effects.RDS"))
Run30 <- readRDS(here::here("2023.RT.Runs","Run30","fit.RDS"))
Run33 <- readRDS(here::here("2023.RT.Runs","Run33","fit.RDS"))
Run34_bad <- readRDS(here::here("2023.RT.Runs","Run34","fit.RDS"))
Run34 <- readRDS(here::here("2023.RT.Runs","Run34","fit_best.RDS"))
dat <- Run34$input$data
std <- summary(Run34$sdrep, "report")
ssb40_ind <- which(rownames(std) == "log_SSB_FXSPR_static")
ssb_ind <- which(rownames(std) == "log_SSB")
ssb_tot_ind <- which(rownames(std) == "log_SSB_all")
#exp(std[which(rownames(std) == "log_SSB_FXSPR_static"),1])
#sum(exp(std[which(rownames(std) == "log_SSB_FXSPR_static")[1:2],1]))
predR_ind <- which(rownames(std) == "log_SPR_FXSPR")
```

\blandscape
```{r compare-asap-wham, echo = FALSE, out.width="75%", fig.align="center", fig.cap = "Comparison of recruitment, spawning stock biomass, and fishing mortality estimates from fitted models in ASAP3, the basic version of WHAM, and the multi-stock extension of WHAM to each regional component, separately, using ASAP3 model input files from the most recent management track assessment."}
knitr::include_graphics(here::here("docs","plots","compare_one_stock_models.png"))
```


```{r, echo = FALSE, out.width="80%", fig.align="center", fig.cap = "Diagram of intervals within the year and configuation of the dynamics of each component of the BSB population."}
knitr::include_graphics(here::here("docs","plots","migration_diagram_1.jpg"))
```
\elandscape

<!-- Jitter -->

```{r jitter-res-1, echo = FALSE, fig.dim =c(7,9), fig.align="center", fig.cap = "Marginal negative log-likelihood and maximum absolute value of gradients for each of 16 jitter iterations."}
jit_res <- readRDS(here::here("2023.RT.Runs",'Run34', "jit_res_1.RDS"))
par(mfrow = c(2,1), oma = c(5,1,1,1), mar = c(1,5,1,1))
plot(sapply(jit_res, function(x) x$obj), xlab = "", ylab = "", xaxt = 'n')
axis(1, labels = F)
grid(col = gray(0.7))
mtext(side = 2, "Marginal NLL", line = 2)
plot(sapply(jit_res, function(x) max(abs(x$grad))), xlab = "", ylab = "")
grid(col = gray(0.7))
mtext(side = 1, "Iteration", outer = TRUE, line = 2)
mtext(side = 2, "Maximum absolute\ngradient", line = 2)
```
\clearpage


```{r jitter-res-2, echo = FALSE, fig.dim =c(7,9), fig.align="center", fig.cap = "Marginal negative log-likelihood and maximum absolute value of gradients for each of 100 jitter iterations from revised Run 34 fit. Red rug lines indicate fits that failed to complete."}
jitsim_files <- grep("jitter_sim", dir(here::here("2023.RT.Runs","Run34","best_sims"), full.names = T), value = T)
jit_res <- lapply(jitsim_files, readRDS)
par(mfrow = c(2,1), oma = c(5,1,1,1), mar = c(1,5,1,1))
x <- sapply(jit_res, function(x) x$obj)
x <- exp(log(-x))
plot(x, xlab = "", ylab = "", log = "y", xaxt = 'n', yaxt = "n", ylim = c(max(x,na.rm=T),min(x,na.rm=T)))
axis(2, at = pretty(x), labels = -pretty(x))
rug((1:length(x))[which(is.na(x))], lwd = 3, ticksize = 0.05, col= "red")
axis(1, labels = F)
grid(col = gray(0.7))
mtext(side = 2, "Marginal NLL", line = 2)
x <- sapply(jit_res, function(x) max(abs(x$grad)))
xlabs <- pretty(x)
#ymax <- max(x[which(x<1e-6)], na.rm =T)
plot(x, xlab = "", ylab = "", log = "y")#, ylim = c(0,ymax))
rug((1:length(x))[which(is.na(x))], lwd = 3, ticksize = 0.05, col= "red")
grid(col = gray(0.7))
mtext(side = 1, "Iteration", outer = TRUE, line = 2)
mtext(side = 2, "Maximum absolute\ngradient", line = 2)
```
<!-- Self-Tests -->

```{r self-test-res-2, echo = FALSE, fig.dim =c(7,9), fig.align="center", fig.cap = "Relative bias of SSB estimates from conditional self test simulations."}
condsim_files <- grep("cond_sim", dir(here::here("2023.RT.Runs","Run34","best_sims"), full.names = T), value = T)
sim_res <- lapply(condsim_files, readRDS)
fit <- readRDS(here::here("2023.RT.Runs","Run34","fit_best.RDS"))

par(mfrow = c(2,1), mar = c(1,1,3,1), oma = c(4,4,1,1))
titles <- c("North","South")
for(i in 1:2){
	SSB_n <- sapply(sim_res, function(x) x$SSB[,i])
	reccpapars <- sapply(sim_res, function(x) x$par[names(x$par) %in% c("log_index_sig_scale")])
	reldiff <- (SSB_n - fit$rep$SSB[,i])/fit$rep$SSB[,i]
	good_grad <- which(sapply(sim_res, function(x) max(abs(x$grad))<1e-5))
	bias_est <- apply(reldiff,1,mean, na.rm =T)
	bias_se <- apply(reldiff,1,sd, na.rm =T)/sqrt(sum(!is.na(reldiff[1,])))
	# bias_est <- apply(reldiff[,good_grad],1,mean)
	# bias_se <- apply(reldiff[,good_grad],1,sd)/sqrt(length(good_grad))
	bias_lo <- bias_est - qnorm(0.975)*bias_se
	bias_hi <- bias_est + qnorm(0.975)*bias_se
	plot(fit$years, bias_est, ylim = range(c(bias_lo,bias_hi)), xlab = "", ylab = "", xaxt = "n")
	if(i==2) axis(1)
	if(i==1) axis(1, labels= F)
	abline(h=0, col = "red")
	grid(col = gray(0.7))
	mtext(side =3, titles[i], line = 0, outer = F)
	polygon(c(fit$years,rev(fit$years)), c(bias_lo, rev(bias_hi)), col=adjustcolor("black", alpha.f=0.4), border = "transparent")
}
mtext(side = 2, "Relative bias (SSB)", line= 2, outer = T)
mtext(side = 1, "Year", line = 2, outer = T)
```

```{r self-test-res-3, echo = FALSE, fig.dim =c(7,9), fig.align="center", fig.cap = "Relative bias of SSB estimates from conditional self test simulations with Rec CPA uncertainty scalar fixed at estimated values."}
condsim_files <- grep("cond_sim", dir(here::here("2023.RT.Runs","Run34","best_sims_alt"), full.names = T), value = T)
sim_res <- lapply(condsim_files, readRDS)
fit <- readRDS(here::here("2023.RT.Runs","Run34","fit_best.RDS"))

par(mfrow = c(2,1), mar = c(1,1,3,1), oma = c(4,4,1,1))
titles <- c("North","South")
for(i in 1:2){
	SSB_n <- sapply(sim_res, function(x) x$SSB[,i])
	reccpapars <- sapply(sim_res, function(x) x$par[names(x$par) %in% c("log_index_sig_scale")])
	reldiff <- (SSB_n - fit$rep$SSB[,i])/fit$rep$SSB[,i]
	good_grad <- which(sapply(sim_res, function(x) max(abs(x$grad))<1e-5))
	bias_est <- apply(reldiff,1,mean, na.rm =T)
	bias_se <- apply(reldiff,1,sd, na.rm =T)/sqrt(sum(!is.na(reldiff[1,])))
	# bias_est <- apply(reldiff[,good_grad],1,mean)
	# bias_se <- apply(reldiff[,good_grad],1,sd)/sqrt(length(good_grad))
	bias_lo <- bias_est - qnorm(0.975)*bias_se
	bias_hi <- bias_est + qnorm(0.975)*bias_se
	plot(fit$years, bias_est, ylim = range(c(bias_lo,bias_hi)), xlab = "", ylab = "", xaxt = "n")
	if(i==2) axis(1)
	if(i==1) axis(1, labels= F)
	abline(h=0, col = "red")
	grid(col = gray(0.7))
	mtext(side =3, titles[i], line = 0, outer = F)
	polygon(c(fit$years,rev(fit$years)), c(bias_lo, rev(bias_hi)), col=adjustcolor("black", alpha.f=0.4), border = "transparent")
}
mtext(side = 2, "Relative bias (SSB)", line= 2, outer = T)
mtext(side = 1, "Year", line = 2, outer = T)
```
<!-- MASE -->

```{r mase-by-index, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "MASE statistics for each index at alternative prediction horizons."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","mase_WHAM for unnamed stock.png"))
```

```{r mase-obs-pred-by-index, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Index observations (black) and predictions for each MASE peel with all index and age composition observations removed."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","predicted_vs_obs_WHAM for unnamed stock.png"))
```

<!-- OSA North Comm-->

```{r osa-North-comm-catch-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for aggregate catch one-step-ahead residuals for the Northern commercial fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_catch_4panel_North_Commercial.png"))
```
```{r osa-North-comm-paa-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for age composition one-step-ahead residuals for the Northern commercial fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_paa_6panel_North_Commercial.png"))
```
```{r osa-North-comm-paa, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "One-step-ahead residuals for age composition of the Northern commercial fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","Catch_age_comp_osa_resids_North_Commercial.png"))
```

<!-- OSA North Rec-->
```{r osa-North-rec-catch-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for aggregate catch one-step-ahead residuals for the Northern recreational fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_catch_4panel_North_Recreational.png"))
```
```{r osa-North-rec-paa-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for age composition one-step-ahead residuals for the Northern recreational fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_paa_6panel_North_Recreational.png"))
```
```{r osa-North-rec-paa, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "One-step-ahead residuals for age composition of the Northern recreational fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","Catch_age_comp_osa_resids_North_Recreational.png"))
```

<!-- OSA North rec cpa -->

```{r osa-North-reccpa-catch-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for aggregate catch one-step-ahead residuals for the Northern Recreational CPA index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_catch_4panel_North_REC_CPA.png"))
```
```{r osa-North-reccpa-paa-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for age composition one-step-ahead residuals for the Northern Recreational CPA index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_paa_6panel_North_REC_CPA.png"))
```
```{r osa-North-reccpa-paa, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "One-step-ahead residuals for age composition of the Northern Recreational CPA index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","Catch_age_comp_osa_resids_North_REC_CPA.png"))
```

<!-- OSA North vast -->

```{r osa-North-vast-catch-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for aggregate catch one-step-ahead residuals for the Northern VAST index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_catch_4panel_North_VAST_Spring.png"))
```
```{r osa-North-vast-paa-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for age composition one-step-ahead residuals for the Northern VAST index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_paa_6panel_North_VAST_Spring.png"))
```
```{r osa-North-vast-paa, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "One-step-ahead residuals for age composition of the Northern VAST index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","Catch_age_comp_osa_resids_North_VAST_Spring.png"))
```

<!-- OSA South Comm-->
```{r osa-South-comm-catch-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for aggregate catch one-step-ahead residuals for the Southern commercial fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_catch_4panel_South_Commercial.png"))
```
```{r osa-South-comm-paa-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for age composition one-step-ahead residuals for the Southern commercial fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_paa_6panel_South_Commercial.png"))
```
```{r osa-South-comm-paa, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "One-step-ahead residuals for age composition of the Southern commercial fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","Catch_age_comp_osa_resids_South_Commercial.png"))
```
<!-- OSA South Rec-->
```{r osa-South-rec-catch-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for aggregate catch one-step-ahead residuals for the Southern recreational fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_catch_4panel_South_Recreational.png"))
```
```{r osa-South-rec-paa-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for age composition one-step-ahead residuals for the Southern recreational fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_paa_6panel_South_Recreational.png"))
```
```{r osa-South-rec-paa, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "One-step-ahead residuals for age composition of the Southern recreational fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","Catch_age_comp_osa_resids_South_Recreational.png"))
```

<!-- OSA South rec cpa -->

```{r osa-South-reccpa-catch-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for aggregate catch one-step-ahead residuals for the Southern Recreational CPA index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_catch_4panel_South_REC_CPA.png"))
```
```{r osa-South-reccpa-paa-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for age composition one-step-ahead residuals for the Southern Recreational CPA index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_paa_6panel_South_REC_CPA.png"))
```
```{r osa-South-reccpa-paa, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "One-step-ahead residuals for age composition of the Southern Recreational CPA index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","Catch_age_comp_osa_resids_South_REC_CPA.png"))
```

<!-- OSA South vast -->

```{r osa-South-vast-catch-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for aggregate catch one-step-ahead residuals for the Southern VAST index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_catch_4panel_South_VAST_Spring.png"))
```
```{r osa-South-vast-paa-summ, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "Summary plots for age composition one-step-ahead residuals for the Southern VAST index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","OSA_resid_paa_6panel_South_VAST_Spring.png"))
```
```{r osa-South-vast-paa, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "One-step-ahead residuals for age composition of the Southern VAST index."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "diagnostics","Catch_age_comp_osa_resids_South_VAST_Spring.png"))
```



<!-- RETRO -->

```{r North-retro-ssb, echo = FALSE, fig.show="hold", out.width="65%", fig.align="center", fig.cap = "Retrospective patterns for SSB of the northern component."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "retro","BSB_North_SSB_retro.png"))
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "retro","BSB_North_SSB_retro_relative.png"))
```
```{r North-retro-F, echo = FALSE, fig.show="hold", out.width="65%", fig.align="center", fig.cap = "Retrospective patterns for average fishing mortality for ages 6 and 7 in the northern region."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "retro","North_Fbar_retro.png"))
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "retro","North_Fbar_retro_relative.png"))
```

```{r South-retro-ssb, echo = FALSE, fig.show="hold", out.width="65%", fig.align="center", fig.cap = "Retrospective patterns for SSB of the southern component."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "retro","BSB_South_SSB_retro.png"))
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "retro","BSB_South_SSB_retro_relative.png"))
```
```{r South-retro-F, echo = FALSE, fig.show="hold", out.width="65%", fig.align="center", fig.cap = "Retrospective patterns for average fishing mortality for ages 6 and 7 in the southern region."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "retro","South_Fbar_retro.png"))
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png", "retro","South_Fbar_retro_relative.png"))
```

<!-- RESULTS -->

```{r bottom-temp, echo = FALSE, out.width="65%", fig.show = "hold", fig.align="center", fig.cap= "Observations and estimates of the bottom temperature covariates in the northern and southern regions from the proposed base model."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","results","Ecov_1_North_BT.png"))
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","results","Ecov_2_South_BT.png"))
```

```{r relative-recruitment-bt, echo = F, eval = T, fig.cap= "Median recruitment with and without temperature ($x$) effects."}
plot(Run33$years_full[-1], Run33$rep$pred_NAA[1,1,-1,1], type = 'l', xlab = "Year", ylab = bquote(Median~ hat(italic(R)[y]*"|"*italic(x)[y])))
lines(null_mod$years[-1], null_mod$rep$pred_NAA[1,1,-1,1], col = "blue")
```

```{r rec-bottom-temp, echo = F, eval = T, fig.cap = "Expected recruitment for the northern component of the black sea bass stock as a function of bottom temperature"}
std <- summary(Run34$sdrep, "fixed")
inds <- list(ssb =which(rownames(std) == "log_SSB_all"))

Ecov_est <- Run34$rep$Ecov_out_R[1,,1]
Ecov <- seq(min(Ecov_est), max(Ecov_est), 0.01)
ind_slope <-which(rownames(std) == "Ecov_beta_R")
ind_int <- which(rownames(std) == "mean_rec_pars")[1] #north

beta <- std[c(ind_int,ind_slope),1]
cov.beta <- Run34$sdrep$cov.fixed[c(ind_int,ind_slope),c(ind_int,ind_slope)]
X <- cbind(1, Ecov)
pred.log.R <- c(X%*%beta)
sd.pred.log.R <- diag(X %*% cov.beta %*% t(X))
ci <- qnorm(0.975)*sd.pred.log.R
ci <- pred.log.R + cbind(-ci,ci)
plot(Ecov, exp(pred.log.R), type = 'l', xlab = "Bottom Temperature", ylab = bquote(North~hat(R)))
polygon(c(Ecov, rev(Ecov)), exp(c(ci[,1],rev(ci[,2]))), col=adjustcolor("black", alpha.f=0.4), border = "transparent")

```


```{r NAA-devs, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Estimated survival deviations from the proposed base model."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","results","NAA_dev_tile.png"))
```

```{r SSB-compare, echo = FALSE, fig.dim =c(7,9), fig.align="center", fig.cap = "Spawning stock biomass estimates from Runs 30, 33 and 34 (including the incorrect optimization). Polygons represent 95\\% confidence intervals."}
rns <- c("Run30","Run33","Run34_bad","Run34")
res <- list()
for(i in 1:length(rns)){
  res[[i]] <- list(Est = TMB:::as.list.sdreport(get(rns[i])$sdrep, report = TRUE, what = "Est")$log_SSB)
  res[[i]]$se <- TMB:::as.list.sdreport(get(rns[i])$sdrep, report = TRUE, what = "Std")$log_SSB
  res[[i]]$ci_lo <- exp(res[[i]]$Est - qnorm(0.975)*res[[i]]$se)
  res[[i]]$ci_hi <- exp(res[[i]]$Est + qnorm(0.975)*res[[i]]$se)
}
cols <- viridisLite::viridis(n=length(rns))
par(mfrow = c(2,1), oma = c(4,4,1,1), mar = c(1,1,1,1))
for(s in 1:2){
  maxy <- max(sapply(res, function(x) max(x$ci_hi[,s])))
  plot(Run34$years, res[[1]]$ci_hi[,s], type = 'n', xaxt = 'n', ylab = '', xlab = '', 
    ylim = c(0, maxy))
  if(s==1) axis(1, labels = F)
  else axis(1)
  grid(col = gray(0.7))
  for(i in 1:length(rns)) {
    lines(Run34$years, exp(res[[i]]$Est[,s]), col = cols[i])
    polygon(c(Run34$years,rev(Run34$years)), c(res[[i]]$ci_lo[,s],rev(res[[i]]$ci_hi[,s])), 
      col = adjustcolor(cols[i], alpha.f = 0.4), border = "transparent")
  }
  mtext(side = 3, Run34$input$stock_names[s], line = 0, outer = F)
}
legend("topleft", col = cols, lty = 1, legend = rns)
mtext(side = 2, "SSB (mt)", line = 2, outer = T)
mtext(side = 1, "Year", outer = T, line = 2)

```

```{r F-compare, echo = FALSE, fig.dim =c(7,9), fig.align="center", fig.cap = "Fully-selected fishing mortality estimates from Runs 30, 33 and 34 (including the incorrect optimization). Polygons represent 95\\% confidence intervals."}
rns <- c("Run30","Run33","Run34_bad","Run34")
res <- list()
for(i in 1:length(rns)){
  res[[i]] <- list(Est = TMB:::as.list.sdreport(get(rns[i])$sdrep, report = TRUE, what = "Est")$log_FAA_by_region)
  res[[i]]$se <- TMB:::as.list.sdreport(get(rns[i])$sdrep, report = TRUE, what = "Std")$log_FAA_by_region
  res[[i]]$ci_lo <- exp(res[[i]]$Est - qnorm(0.975)*res[[i]]$se)
  res[[i]]$ci_hi <- exp(res[[i]]$Est + qnorm(0.975)*res[[i]]$se)
  res[[i]]$which_age <- apply(res[[i]]$Est[s,,],1,function(x) which(x==max(x))[1])
}
cols <- viridisLite::viridis(n=length(rns))
par(mfrow = c(2,1), oma = c(4,4,1,1), mar = c(1,1,1,1))
for(s in 1:2){
  maxy <- max(sapply(res, function(x) max(x$ci_hi[s,,][cbind(1:33,x$which_age)])))
  plot(Run34$years, res[[1]]$ci_hi[s,,1], type = 'n', xaxt = 'n', ylab = '', xlab = '', 
    ylim = c(0, maxy))
  if(s==1) axis(1, labels = F)
  else axis(1)
  grid(col = gray(0.7))
  for(i in 1:length(rns)) {
    lines(Run34$years, exp(res[[i]]$Est[s,,][cbind(1:33,res[[i]]$which_age)]), col = cols[i])
    polygon(c(Run34$years,rev(Run34$years)),
      c(res[[i]]$ci_lo[s,,][cbind(1:33,res[[i]]$which_age)],rev(res[[i]]$ci_hi[s,,][cbind(1:33,res[[i]]$which_age)])), 
      col = adjustcolor(cols[i], alpha.f = 0.4), border = "transparent")
  }
  mtext(side = 3, Run34$input$region_names[s], line = 0, outer = F)
}
legend("topright", col = cols, lty = 1, legend = rns)
mtext(side = 2, "Fully-selected F", line = 2, outer = T)
mtext(side = 1, "Year", outer = T, line = 2)

```


```{r R-compare, echo = FALSE, fig.dim =c(7,9), fig.align="center", fig.cap = "Recruitment estimates from Runs 30, 33 and 34 (including the incorrect optimization). Polygons represent 95\\% confidence intervals."}
rns <- c("Run30","Run33","Run34_bad","Run34")
res <- list()
for(i in 1:length(rns)){
  res[[i]] <- list(Est = TMB:::as.list.sdreport(get(rns[i])$sdrep, report = TRUE, what = "Est")$log_NAA_rep)
  res[[i]]$se <- TMB:::as.list.sdreport(get(rns[i])$sdrep, report = TRUE, what = "Std")$log_NAA_rep
  res[[i]]$ci_lo <- exp(res[[i]]$Est - qnorm(0.975)*res[[i]]$se)
  res[[i]]$ci_hi <- exp(res[[i]]$Est + qnorm(0.975)*res[[i]]$se)
}
cols <- viridisLite::viridis(n=length(rns))
par(mfrow = c(2,1), oma = c(4,4,1,1), mar = c(1,1,1,1))
for(s in 1:2){
  maxy <- max(sapply(res, function(x) max(x$ci_hi[s,s,,1])))
  plot(Run34$years, res[[1]]$ci_hi[s,s,,1], type = 'n', xaxt = 'n', ylab = '', xlab = '', 
    ylim = c(0, maxy))
  if(s==1) axis(1, labels = F)
  else axis(1)
  grid(col = gray(0.7))
  for(i in 1:length(rns)) {
    lines(Run34$years, exp(res[[i]]$Est[s,s,,1]), col = cols[i])
    polygon(c(Run34$years,rev(Run34$years)), c(res[[i]]$ci_lo[s,s,,1],rev(res[[i]]$ci_hi[s,s,,1])), 
      col = adjustcolor(cols[i], alpha.f = 0.4), border = "transparent")
  }
  mtext(side = 3, Run34$input$stock_names[s], line = 0, outer = F)
}
legend("topleft", col = cols, lty = 1, legend = rns)
mtext(side = 2, "Recruitment (1000s)", line = 2, outer = T)
mtext(side = 1, "Year", outer = T, line = 2)

```


```{r relative-se-ssb-R, echo = F, eval = T, fig.dim = c(7,9), fig.cap = "Ratio of standard errors of Northern component SSB (top) and recruitment (bottom) for fitted models with ($SE_1$) and without ($SE_2$) the scalar of the Recreational CPA index standard errors estimated."}
par(mfrow = c(2,1), mar = c(1,5,3,1), oma = c(4,1,1,1))

sd33 <- TMB:::as.list.sdreport(Run33$sdrep, report=TRUE, what = "Std")$log_SSB[,1]
sd34 <- TMB:::as.list.sdreport(Run34$sdrep, report=TRUE, what = "Std")$log_SSB[,1]

plot(Run33$years_full, sd34/sd33, ylab = bquote(SE[1](widehat(SSB))*"/"*SE[2](widehat(SSB))), xlab = "", xaxt = "n", type = "l")
abline(h = 1, lty = 2, col = "red")

sd33 <- TMB:::as.list.sdreport(Run33$sdrep, report=TRUE, what = "Std")$log_NAA_rep[1,1,,1]
sd34 <- TMB:::as.list.sdreport(Run34$sdrep, report=TRUE, what = "Std")$log_NAA_rep[1,1,,1]

plot(Run33$years_full, sd34/sd33, ylab = bquote(SE[1](hat(R))*"/"*SE[2](hat(R))), xlab = "", type = "l")
mtext(side = 1, "Year", outer = T, line = 2)
abline(h = 1, lty = 2, col = "red")
```

\clearpage

```{r move-prior-posterior, echo = F, eval= T, fig.cap = "Prior (black) and posterior (red) distributions of movement of northern component stock from north to south (top) and south to north (bottom)"}
dlogitnorm <- function(x, p, sigma){

	y <- log(x/(1-x))
	mu <- log(p/(1-p))
	fx <- dnorm(y, mu, sigma, log = F) /(x*(1-x)) 
	return(fx)
}

par(mfrow = c(2,1), mar = c(4,4,1,1), oma = c(1,1,1,1))
ps <- seq(0,0.1,0.001)
#prior for both north-south and south-north
plot(ps, dlogitnorm(ps,0.02214863, 0.2), type = 'l', lwd = 2, xlab = "P(North to South)", ylab = "f(P)", ylim = c(0,300))
abline(v=0.02214863, lwd =2)
#posterior for north to south
lines(ps, dlogitnorm(ps, p = Run34$rep$mu[1,8,8,1,1,2], sigma = TMB:::as.list.sdreport(Run34$sdrep, "Std")$mu_prior_re[1,8,1,1]), lwd = 2, col = "red")
abline(v=Run34$rep$mu[1,8,8,1,1,2], col = "red", lwd = 2)

ps <- seq(0,0.6,0.001)
plot(ps, dlogitnorm(ps,0.3130358, 0.2), type = 'l', lwd = 2, xlab = "P(South to North)", ylab = "f(P)")
abline(v=0.3130358, lwd =2)
#posterior for north to south
lines(ps, dlogitnorm(ps, p = Run34$rep$mu[1,8,1,1,2,1], sigma = TMB:::as.list.sdreport(Run34$sdrep, "Std")$mu_prior_re[1,8,2,1]), lwd = 2, col = "red")
abline(v=Run34$rep$mu[1,8,1,1,2,1], col = "red", lwd = 2)

```

\clearpage
```{r selectivity, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Estimated selectivity for indices and fleets from the proposed base model."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","results","SelAA_tile.png"))
```

```{r SSB-R-time, echo = FALSE, out.width="65%", fig.show = "hold", fig.align="center", fig.cap= "Estimated Spawning stock biomass and recruitment for the northern and southern components."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","results","SSB_Rec_time_BSB_North.png"))
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","results","SSB_Rec_time_BSB_South.png"))
```

```{r SSB-F, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Estimated spawning stock biomass for regional components and fully-selected fishing mortalty for each region with 95\\% confidence intervals. Polygons represents 95\\% confidence intervals."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","results","SSB_F_trend.png"))
```
\clearpage

```{r F-by-fleet, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Estimated fully-selected fishing mortality for each fleet."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","results","F_byfleet.png"))
```

<!-- BRPS-->

```{r annual-BRPs, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Estimated equilibrium fully-selected fishing mortality, spawning stock biomass, and yield at 40\\% of unfished spawning stock biomass per recruit. Annual values of inputs to per recruit calculations are used for the corresponding annual BRP estimates. Polygons represents 95\\% confidence intervals."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","ref_points","FSPR_absolute.png"))
```
(ref:annual-status-caption) Status of fishing mortality rates and spawning stock biomass relative to annual reference point estimates in Figure \ref{fig:annual-BRPs}. Gray polygon represents 95\\% confidence intervals.

```{r annual-status, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "(ref:annual-status-caption)"}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","ref_points","FSPR_relative.png"))
```

```{r kobe-status, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Kobe plot of status of fishing mortality and spawning stock biomass relative to corresponding reference point estimates ($F_{40}$ and $SSB(F_{40})$) using average of inputs to per-recruit calculations over 2017-2021. $SSB(F_{40})$ uses average recruitment from 2000 to 2021. Polygon represent a 95\\% confidence region."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","plots_png","ref_points","Kobe_status.png"))
```

\clearpage
<!-- PROJECTIONS-->

```{r bottom-temp-proj, echo = FALSE, out.width="65%", fig.show = "hold", fig.align="center", fig.cap= "Observations and estimates of the bottom temperature covariates in the northern region from the proposed base model. Horizontal dashed line indicates when projection period begins."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","projections","plots_png","results","Ecov_1_North_BT.png"))
```

```{r NAA-devs-proj, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Estimated survival deviations from the proposed base model. Horizontal dashed line indicates when projection period begins."}
knitr::include_graphics(here::here("2023.RT.Runs", "Run34", "projections", "plots_png", "results", "NAA_dev_tile.png"))
```

```{r SSB-R-time-proj, echo = FALSE, out.width="65%", fig.show = "hold", fig.align="center", fig.cap= "Estimated Spawning stock biomass and recruitment for the northern and southern components. Horizontal dashed line indicates when projection period begins."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","projections", "plots_png","results","SSB_Rec_time_BSB_North.png"))
knitr::include_graphics(here::here("2023.RT.Runs","Run34","projections", "plots_png","results","SSB_Rec_time_BSB_South.png"))
```

```{r SSB-F-proj, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Estimated spawning stock biomass for regional components and fully-selected fishing mortalty for each region with 95\\% confidence intervals. Horizontal dashed line indicates when projection period begins."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","projections", "plots_png","results","SSB_F_trend.png"))
```
\clearpage

```{r F-by-fleet-proj, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Estimated fully-selected fishing mortality for each fleet. Horizontal dashed line indicates when projection period begins."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34","projections", "plots_png","results","F_byfleet.png"))
```

```{r kobe-status-proj, echo = FALSE, out.width="100%", fig.align="center", fig.cap= "Kobe plot of status of fishing mortality and spawning stock biomass relative to corresponding reference point estimates ($F_{40}$ and $SSB(F_{40})$) using average of inputs to per-recruit calculations over 2017-2021. $SSB(F_{40})$ uses average recruitment from 2000 to 2021. Polygons represent a 95\\% confidence region."}
knitr::include_graphics(here::here("2023.RT.Runs","Run34", "projections", "plots_png","ref_points","Kobe_status.png"))
```




\clearpage

<!-- TABLES -->

```{r wham-runs, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
dat <- read.csv(here::here("docs","wham_runs.csv"), colClasses="character")
dat %>% kable(format = type, booktabs = T, escape=F, longtable = T, caption="WHAM runs with description and comments.") %>%
  column_spec(2:3, width = c("10cm","12cm")) %>% 
  #row_spec(c(4,17), bold = TRUE) %>%
  kable_styling(latex_options=c("repeat_header")) %>% landscape()

# out <- out %>% kable(format = type, booktabs = T, escape=F, longtable = T, row.names = T,label = "par-table",
#     caption="Parameter estimates, standard errors, and confidence intervals. Rounded to 3 decimal places.", align = c(rep("r",4))) %>%
#     kable_styling(latex_options=c("basic", "repeat_header")) %>% landscape()
# knitr::knit_print(out)

```
\clearpage


```{r, echo = F, eval = T}
age_comp_names <- c("North Commercial", "North Recreational", "South Commercial", "South Recreational",
  "North Recreational CPA", "North VAST", "South Recreational CPA", "South VAST")
age_comp_mod <- c("Dirichlet-Multinomial", "Logistic-normal (0s as missing)", "Logistic-normal (AR1, 0s as missing)","Logistic-normal (AR1, 0s as missing)", "Logistic-normal (0s as missing)","Dirichlet-Multinomial","Logistic-normal (AR1, 0s as missing)","Logistic-normal (AR1, 0s as missing)")
mean_sel_mod <- c("age-specific (flat-topped at ages > 3)",
  "age-specific (flat-topped at ages > 6)",
  "logistic", "logistic",
  "age-specific (flat-topped at ages > 1)",
  "age-specific (flat-topped at ages > 4)",
  "age-specific (flat-topped at ages > 2)",
  "age-specific (flat-topped at ages > 1)")
sel_re_mod <- c("2D-AR1 (age and year)", 
  "2D-AR1 (age and year)",
  "None",
  "None",
  "AR1 (year)",
  "2D-AR1 (age and year)",
  "None",
  "None")
out <- cbind.data.frame("Data component" = age_comp_names,  "Age Composition Likelihood" = age_comp_mod,  
  "Mean Selectivity model" = mean_sel_mod, "Random effects configuration" = sel_re_mod)

out %>% kable(format = type, booktabs = T, escape=F, row.names = F, label = "age-comp-sel-table",
    caption="Configuration of Age composition likelihood, mean selectivity model, and selectivity random effects for each age composition data component in Run 34.", align = c(rep("l",4))) %>% landscape()
#knitr::knit_print(kableExtra::landscape(out))

```

\clearpage


```{r, echo = F, eval = T}
mods <- c("null_mod","Run33", "sat_mod")
AIC <- round(2*(sapply(mods, function(x) get(x)$opt$obj + length(get(x)$opt$par))), 2)
Rsig <- round(sapply(mods, function(x) exp(get(x)$parList$log_NAA_sigma[1,1,1])),2)
out <- cbind(AIC = AIC, "North $\\widehat{\\sigma}_R$" = Rsig)
rownames(out) <- c("No effect", "North temperature effect only", "Both temperature effects")
out <- kable(out, format = type, booktabs = T, escape=F, row.names = T,label = "compare-table",
    caption="Comparison of AIC and estimates of standard deviation of recruitment for models without any temperature effects on recruitment, with just effects on the northern component, and with effects on both components for Run 33.", align = c(rep("r",2)))
knitr::knit_print(out)
#cat(knitr::knit_print(out))
```
\clearpage

```{r par-estimates, echo = F, eval = T}
out = as.data.frame(readRDS(here::here("2023.RT.Runs","Run34","res_tables","parameter_estimates_table.RDS")))
#out = round(out, 3)
out <- wham:::sci_note(out,cols=1:4)
out <- out %>% kable(format = type, booktabs = T, escape=F, longtable = T, row.names = T,label = "par-table",
    caption="Parameter estimates, standard errors, and confidence intervals for the proposed base model.", align = c(rep("r",4))) %>%
    kable_styling(latex_options=c("basic", "repeat_header")) %>% landscape()
knitr::knit_print(out)

```






\clearpage


<!-- 

## Projections

WHAM has several options for handling short-term projections internally. Code to run short-term projections for the final three WHAM models can be seen at `/code/project_models.R`. 

Projections under alternative $F$ for catch advice will be done in the upcoming management track assessment using data through 2021. Here we simply demonstrate how this would be done using WHAM. We show three alternative $F$ scenarios over a 3-year projection period: $F=0$, $F=F_{2019}$ (terminal year $F$ / status quo), and $F=F_{50\%}$ ($F_{MSY}$ proxy).

## Reference points and status determination

In 2019, the butterfish stock was not overfished ($B_{2019}/B_{50\%}$ > 1) or experiencing overfishing ($F_{2019}/F_{50\%}$ < 1) in all models (Table \ref{tab:refpts}).


The three WHAM models estimated similar trends in SSB, $F$, and recruitment as ASAP (Fig. \ref{fig:ssb-rec-f}). The main difference is that the state-space models, 04-NAA2 and 17-NAA5, estimated less of a decrease in recruitment and SSB over the time-series, i.e. lower recruitment and SSB in early years and higher recruitment and SSB in later years. Recruitment in the full state-space model, 17-NAA5, was notably higher in 2008-2019 (Fig. \ref{fig:ssb-rec-f}), which corresponds to a period of negative survival deviations for fish aged 1+ (Fig. \ref{fig:naa-devs}).

All models estimated that the stock has never been overfished or experienced overfishing ($B/B_{50\%}$ > 1 and $F/F_{50\%}$ < 1 in all years, Fig. \ref{fig:status}).

-->

<!-- We show 3-year projections of recruitment and SSB under 3 alternative $F$ scenarios: $F=0$ (Fig. \ref{fig:proj-panel-f0}), $F=F_{2019}$ (Fig. \ref{fig:proj-panel-flast}), and $F=F_{50\%}$ (Fig. \ref{fig:proj-panel-f50}). 17-NAA5 estimates a larger population size (higher SSB) than the other two models, even with similar $F$ and the same $M$, because survival deviations for ages 1+ were estimated to be positive (Figs. \ref{fig:naa-devs} and \ref{fig:proj-panel-f0}-\ref{fig:proj-panel-f50}).  -->

<!-- SSB remains roughly the same in 2022 relative to 2021, with slight increases in 17-NAA5 due to increasing recruitment and positive survival deviations in the projection period (Figs. \ref{fig:naa-devs} and \ref{fig:proj-panel-flast}).-->

<!-- Note the effect of treating projected recruitment as a continuation of the AR(1) process (or not, as in 04-Base). Recruitment in 04-Base jumps immediately to the 2011-2019 average but recruitment in 04-NAA2 and 17-NAA5 gradually approach average recruitment (Figs. \ref{fig:proj-panel-f0}-\ref{fig:proj-panel-f50}). -->


